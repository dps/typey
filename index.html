<html>
<head>
    <title>Typey McTypeface</title>
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        .secondary {
            background-color: dimgray;
            color: silver;
            border-color: darkgray;
        }
        .hammerspoon-config {
            min-height: 200px;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="notice">
        <h1>Typey McTypeface &nbsp; ü™Ñ‚å®Ô∏è</h1>
        <p>Record your keystrokes so you can play them back again later and make your demo look ‚ú®ü¶Ñüåà.</p>
        <div>
            <input id="inp" type="text" style="width:100%;" placeholder="Type here to record keystrokes" />
            <button class="secondary" onclick="reset()">Start over</button> <button onclick="saveKeystrokes()">Save Keystrokes</button>
            <p id="strokes"></p>
        </div>
    </div>
    <pre class="hammerspoon-config"><code id="output" class="language-lua"></code></pre>

<script>
const header = "// üî®ü•Ñ Example hammerspoon config";
const remainder = "function typeOutKeystrokes(keystrokes)\n    -- Ensure the frontmost application is active to receive keystrokes\n    hs.application.frontmostApplication():activate()\n    -- Function to \"type\" each character with a specific delay\n    for i, stroke in ipairs(keystrokes) do\n        hs.timer.doAfter((stroke.delay/1000)*0.5, function()\n            if stroke.key == \"Backspace\" then\n                hs.eventtap.keyStroke({}, \"delete\")\n            else\n                hs.eventtap.keyStrokes(stroke.key)\n            end\n        end)\n    end\nend\nhs.hotkey.bind({\"alt\"}, \"1\", function()\n    typeOutKeystrokes(keystrokes)\nend)";

const input = document.getElementById("inp");
const strokes = document.getElementById("strokes");
const output = document.getElementById('output');

let keystrokes = [];
let firstTimestamp = null;
let strokeCount = 0;

document.addEventListener('keydown', function(event) {
    if (document.activeElement !== input) {
      return;
    }

    const timestamp = Date.now();  // Get the current timestamp
    if (firstTimestamp === null) firstTimestamp = timestamp;  // Set the first timestamp

    strokeCount += 1;
    strokes.innerHTML = strokeCount + " keystrokes recorded";
    keystrokes.push({
        key: event.key,
        delay: timestamp - firstTimestamp  // Calculate the time difference
    });
});

function setOutput(keystrokes) {
  output.innerHTML = `${header}\nkeystrokes = {\n${keystrokes}}\n\n${remainder}`;
  output.removeAttribute('data-highlighted');

  hljs.highlightAll();
}

function reset() {
    keystrokes = [];
    firstTimestamp = null;
    strokeCount = 0;
    strokes.innerHTML = "";
    input.value = "";
    setOutput('');
}

function saveKeystrokes() {
    console.log(keystrokes);
    let luaArray = "";
    keystrokes.forEach(stroke => {
        luaArray += `    { key = "${stroke.key.replace(/"/g, '\\"')}", delay = ${stroke.delay} },\n`;  // Escape double quotes
    });
    console.log(luaArray);
    setOutput(luaArray);
}

output.addEventListener('click', function() {
   // Create a range and a selection to select the text
   const range = document.createRange();
   const selection = window.getSelection();
   
   // Clear current selection
   selection.removeAllRanges();
   
   // Select the text inside the div
   range.selectNodeContents(this);
   selection.addRange(range);
   
   try {
      document.execCommand('copy');
   } catch (err) {
      alert('Failed to copy text');
   }
   
   // Clear selection if you do not want it to stay highlighted
   selection.removeAllRanges();

   const previousStrokes = strokes.innerHTML;
   strokes.innerHTML = "Config copied";

   setTimeout(function () {
     strokes.innerHTML = previousStrokes;
   }, 1000);
});

setOutput('');

</script>
</body>
</html>